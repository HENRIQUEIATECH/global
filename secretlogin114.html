<script>
    // NOVO: Ao carregar a página, já preenche o e-mail se ele existir na memória
    window.onload = function() {
        const savedEmail = localStorage.getItem('userEmail');
        if (savedEmail) {
            document.getElementById('portalEmail').value = savedEmail;
        }
    };

    function validatePortal(e) {
        e.preventDefault();
        
        const inputEmail = document.getElementById('portalEmail').value;
        const inputToken = document.getElementById('portalToken').value;
        const cleanToken = inputToken.trim().toUpperCase();
        
        // Recupera os dados salvos anteriormente para validação cruzada
        const registeredEmail = localStorage.getItem('userEmail');
        const generatedKey = localStorage.getItem('finalKey'); // Aquela que geramos na 113

        // LOGICA DE SEGURANÇA IARTIUM
        // 1. O token deve conter "-SNC"
        // 2. (Opcional) O e-mail deve ser o mesmo do registro inicial
        if(cleanToken.includes("-SNC")) {
            
            // Verificação extra de e-mail para evitar que terceiros usem o token
            if (registeredEmail && inputEmail !== registeredEmail) {
                alert("ERRO DE IDENTIDADE: O e-mail informado não coincide com o Node ID registrado.");
                return;
            }

            // Se chegou aqui, os dados coincidem!
            console.log("Handshake Protocol: SUCCESS");
            console.log("Identity Verified: " + inputEmail);

            // Salvamos que o login foi realizado com sucesso
            localStorage.setItem('isLoggedIn', 'true');

            alert("ACESSO AUTORIZADO. Sincronizando com os Nodes de New York e Suíça...");
            
            // Redirecionamento para a Dashboard real (Página 115)
            window.location.href = "sincronia-global-115.html"; 
            
        } else {
            alert("ERRO DE PROTOCOLO: O Token inserido é inválido ou não possui assinatura SNC ativa.");
            document.getElementById('portalToken').value = "";
        }
    }
</script>
