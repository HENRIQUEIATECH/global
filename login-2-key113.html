<script>
    let nameSum = 0;

    // NOVO: Recupera√ß√£o autom√°tica dos dados da P√°gina 112 ao carregar
    window.onload = function() {
        const savedName = localStorage.getItem('userName');
        if (savedName) {
            // Preenche o campo de nome automaticamente
            const nameInput = document.getElementById('userName');
            nameInput.value = savedName.toUpperCase();
            
            // Dispara a verifica√ß√£o visual para liberar o bot√£o de WhatsApp
            checkInputs();
            
            console.log("Dados transportados da 112: " + savedName);
        }
    };

    // Loader de processamento IArtium (Original mantido)
    function runIArtium(callback) {
        document.getElementById('loader').style.display = 'block';
        let bar = document.getElementById('loader-bar');
        bar.style.width = "0%";
        setTimeout(() => bar.style.width = "100%", 100);
        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
            callback();
        }, 800);
    }

    // Monitora preenchimento de Nome e WhatsApp (Original mantido)
    function checkInputs() {
        const name = document.getElementById('userName').value;
        const wa = document.getElementById('userWhatsApp').value;
        const waClean = wa.replace(/\D/g, ''); 
        const isReady = name.length >= 2 && waClean.length >= 10;
        document.getElementById('btn-name').classList.toggle('btn-show', isReady);
    }

    // ETAPA 01: Confirma Identidade e gera a soma num√©rica
    function confirmIdentity() {
        runIArtium(() => {
            const nameRaw = document.getElementById('userName').value;
            const wa = document.getElementById('userWhatsApp').value;
            const name = nameRaw.toLowerCase();
            
            // C√°lculo da Identidade Num√©rica (Original mantido)
            nameSum = 0;
            for (let i = 0; i < name.length; i++) {
                let code = name.charCodeAt(i) - 96;
                if (code > 0 && code <= 26) nameSum += code;
            }
            
            // Mensagem para WhatsApp (Original mantida)
            const saudacao = `Ol√°, ${nameRaw}! √â um prazer receb√™-lo na Holding Paulo Salom√£o. üèõÔ∏è%0A%0APara garantir a cust√≥dia soberana de seus ativos, o protocolo SecretKey gerou sua Identidade Num√©rica √∫nica:%0A%0Aüîë C√ìDIGO DE ACESSO (N√≥ Su√≠√ßa): *${nameSum}*%0A%0APor favor, insira este valor no terminal para sincronizar suas chaves globais. Sua seguran√ßa √© nossa prioridade absoluta. üõ°Ô∏è`;
            
            window.open(`https://api.whatsapp.com/send?phone=${wa}&text=${saudacao}`, '_blank');

            document.getElementById('nameStatus').innerHTML = "<span class='text-green-600 font-bold'>‚óè MENSAGEM DE BOAS-VINDAS ENVIADA</span>";
            document.getElementById('node-ny').classList.add('node-active');
            document.getElementById('btn-name').style.display = 'none';
            document.getElementById('passSW').type = "password";
        });
    }

    // ETAPA 02 e 03 (Originais mantidas)
    function checkPass(node) {
        const val = document.getElementById('pass' + node.toUpperCase()).value;
        document.getElementById('btn-' + node).classList.toggle('btn-show', val.length > 0);
    }

    function confirmNY() {
        runIArtium(() => {
            document.getElementById('node-ny').classList.add('completed');
            document.getElementById('node-sw').classList.add('node-active');
            document.getElementById('btn-ny').style.display = 'none';
        });
    }

    function confirmSW() {
        const val = parseInt(document.getElementById('passSW').value);
        if(val === nameSum) {
            runIArtium(() => {
                document.getElementById('node-sw').classList.add('completed');
                document.getElementById('node-br').classList.add('node-active');
                
                // Gera a Key Final e SALVA para usar na 114/116
                const keyFinal = "HPS-" + nameSum + "-" + Math.floor(Math.random()*999) + "-SNC";
                document.getElementById('passBR').value = keyFinal;
                localStorage.setItem('finalKey', keyFinal); // SALVANDO A CHAVE
                
                document.getElementById('node-br').classList.add('completed');
                document.getElementById('btn-copy').classList.remove('hidden');
                document.getElementById('finalBtn').classList.add('btn-ready');
                document.getElementById('btn-sw').style.display = 'none';
            });
        } else { 
            alert("Erro de Sincronia: O valor inserido n√£o corresponde √† sua Identidade Num√©rica."); 
        }
    }

    // Finaliza√ß√£o e Redirecionamento (Original atualizado)
    function deploySystem() {
        alert("PROTOCOLO FINALIZADO: Handshake estabelecido com Node Global. Redirecionando para Terminal de Governan√ßa...");
        window.location.href = "secretlogin114.html"; 
    }
    
    // Fun√ß√£o copiar (Original mantida)
    function copyKey() {
        const copyText = document.getElementById("passBR");
        copyText.select();
        navigator.clipboard.writeText(copyText.value);
        const btn = document.getElementById('btn-copy');
        btn.innerHTML = "KEY COPIADA!";
        btn.classList.add('bg-green-600', 'text-white');
    }
</script>
